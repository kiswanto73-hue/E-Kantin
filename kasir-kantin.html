<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Kantin - Scan & Bayar</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-20">
    <div class="max-w-md mx-auto p-4">
        <div class="bg-indigo-900 text-white p-6 rounded-[2rem] shadow-xl mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black italic">KASIR KANTIN üõí</h1>
                <p id="namaStanTerpilih" class="text-[10px] font-bold text-indigo-300 uppercase italic">Pilih Stan Anda</p>
            </div>
            <a href="dashboard-kantin.html" class="text-xs bg-indigo-800 p-2 rounded-xl border border-indigo-400">MENU</a>
        </div>

        <select id="selectStan" onchange="loadMenuStan()" class="w-full p-4 rounded-2xl mb-4 bg-white shadow-sm font-bold border-2 border-indigo-100 outline-none focus:border-indigo-500">
            <option value="">-- PILIH UNIT STAN --</option>
            <option value="STAN MAKANAN">STAN MAKANAN</option>
            <option value="STAN MINUMAN">STAN MINUMAN</option>
            <option value="STAN SNACK">STAN SNACK</option>
        </select>

        <div id="menuContainer" class="grid grid-cols-2 gap-3 mb-6"></div>

        <div class="bg-white p-6 rounded-[2rem] shadow-sm sticky bottom-4 border-2 border-indigo-50">
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-1">Total Tagihan:</h3>
            <div id="totalTagihan" class="text-3xl font-black text-indigo-900 mb-2">Rp 0</div>
            <p id="listBelanja" class="text-[10px] text-slate-400 italic mb-4 truncate">Belum ada item</p>
            <div class="flex gap-2">
                <button onclick="resetKeranjang()" class="bg-red-100 text-red-600 p-4 rounded-2xl font-bold text-xs">RESET</button>
                <button onclick="bukaScanner()" id="btnBayar" class="flex-1 bg-indigo-600 text-white font-black p-4 rounded-2xl shadow-lg hidden uppercase tracking-wider text-sm">PROSES BAYAR üí≥</button>
            </div>
        </div>
    </div>

    <div id="modalScanner" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex flex-col items-center justify-center p-6 text-white">
        <div class="w-full max-w-sm bg-white rounded-[2rem] overflow-hidden p-4">
            <div id="reader"></div>
            <button onclick="tutupScanner()" class="w-full mt-4 bg-red-500 text-white font-bold p-3 rounded-xl">BATAL</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let keranjang = 0;
        let itemTerpilih = [];
        let html5QrCode;

        function loadMenuStan() {
            const stan = document.getElementById('selectStan').value;
            const container = document.getElementById('menuContainer');
            document.getElementById('namaStanTerpilih').innerText = stan || "Pilih Stan Anda";
            resetKeranjang();

            if(!stan) return;
            db.ref('kantin_menus/' + stan).on('value', snapshot => {
                container.innerHTML = "";
                snapshot.forEach(child => {
                    const menu = child.val();
                    container.innerHTML += `
                        <button onclick="tambahItem('${menu.nama}', ${menu.harga})" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-transparent active:scale-95 transition-all text-left">
                            <p class="text-[10px] font-black text-indigo-500 uppercase">${menu.nama}</p>
                            <p class="font-bold text-slate-700 text-sm">Rp ${menu.harga.toLocaleString()}</p>
                        </button>`;
                });
            });
        }

        function tambahItem(nama, harga) {
            keranjang += harga;
            itemTerpilih.push(nama);
            updateTotal();
        }

        function updateTotal() {
            document.getElementById('totalTagihan').innerText = "Rp " + keranjang.toLocaleString();
            document.getElementById('listBelanja').innerText = itemTerpilih.join(", ") || "Belum ada item";
            document.getElementById('btnBayar').style.display = keranjang > 0 ? "block" : "none";
        }

        function resetKeranjang() {
            keranjang = 0;
            itemTerpilih = [];
            updateTotal();
        }

        function bukaScanner() {
            document.getElementById('modalScanner').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        }

        function onScanSuccess(decodedText) {
            tutupScanner();
            const idSiswa = decodedText.trim();
            const stan = document.getElementById('selectStan').value;

            db.ref('kantin_users/' + idSiswa).once('value', snapshot => {
                const user = snapshot.val();
                if(!user) return alert("‚ùå Siswa tidak terdaftar!");
                if(user.saldo < keranjang) return alert("‚ùå Saldo Kurang!");

                const saldoBaru = user.saldo - keranjang;
                db.ref('kantin_users/' + idSiswa + '/saldo').set(saldoBaru);
                db.ref('kantin_laporan').push({
                    idSiswa: idSiswa,
                    namaSiswa: user.nama,
                    stan: stan,
                    item: itemTerpilih.join(", "),
                    total: keranjang,
                    waktu: new Date().toLocaleString('id-ID')
                });

                alert("‚úÖ BERHASIL!\nSiswa: " + user.nama + "\nSisa Saldo: Rp " + saldoBaru.toLocaleString());
                resetKeranjang();
            });
        }

        function tutupScanner() {
            if(html5QrCode) html5QrCode.stop();
            document.getElementById('modalScanner').classList.add('hidden');
        }
    </script>
</body>
</html>
