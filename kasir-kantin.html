<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Kantin Terpadu</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 font-sans">

    <div class="max-w-5xl mx-auto p-4 lg:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-indigo-900 p-6 rounded-[2.5rem] text-white shadow-xl">
                    <h1 class="text-xl font-black italic">KASIR TERPADU ðŸ›’</h1>
                    <p class="text-[10px] font-bold opacity-60 uppercase">Pilih menu dari stan manapun</p>
                </div>

                <div id="menuContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl sticky top-8 border-t-8 border-indigo-600">
                    <h2 class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">Keranjang Belanja</h2>
                    
                    <div id="cartItems" class="space-y-3 mb-6 max-h-[300px] overflow-y-auto">
                        <p class="text-center text-slate-300 text-xs italic py-10">Keranjang masih kosong</p>
                    </div>

                    <div class="border-t-2 border-dashed pt-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-400 uppercase">Total Bayar</span>
                            <span id="totalHarga" class="text-2xl font-black text-indigo-600">Rp 0</span>
                        </div>
                    </div>

                    <div id="scannerArea" class="hidden space-y-4">
                        <div id="reader" class="rounded-2xl overflow-hidden border-2 border-indigo-100"></div>
                        <p class="text-[10px] text-center font-bold text-orange-500 animate-pulse uppercase">Silakan Scan Kartu Siswa</p>
                    </div>

                    <button id="btnCheckout" onclick="bukaScanner()" class="w-full bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-emerald-600 transition-all uppercase text-xs tracking-widest">
                        Proses Pembayaran
                    </button>
                    <button onclick="resetCart()" class="w-full mt-2 text-slate-400 font-bold text-[9px] uppercase">Kosongkan Keranjang</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cart = [];
        let total = 0;

        // LOAD MENU DARI SEMUA STAN
        db.ref('kantin_menus').on('value', snap => {
            const container = document.getElementById('menuContainer');
            container.innerHTML = "";
            snap.forEach(stanSnap => {
                const stanNama = stanSnap.key;
                let html = `<div class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-50"><h3 class="text-[9px] font-black text-indigo-400 mb-3 uppercase tracking-tighter">${stanNama}</h3>`;
                stanSnap.forEach(mSnap => {
                    const m = mSnap.val();
                    const idMenu = mSnap.key;
                    const stok = m.stok || 0;
                    const disabled = stok <= 0 ? 'opacity-50 pointer-events-none' : '';
                    
                    html += `
                        <button onclick="addToCart('${stanNama}','${m.nama}',${m.harga},'${idMenu}')" class="${disabled} w-full text-left mb-2 p-3 bg-slate-50 rounded-2xl hover:bg-indigo-50 transition-all border border-transparent hover:border-indigo-200 group">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-black text-slate-700 uppercase group-hover:text-indigo-600">${m.nama}</p>
                                    <p class="text-[10px] font-bold text-emerald-600 italic">Rp ${m.harga.toLocaleString()}</p>
                                </div>
                                <span class="text-[9px] font-bold text-slate-300">Stok: ${stok}</span>
                            </div>
                        </button>`;
                });
                container.innerHTML += html + `</div>`;
            });
        });

        function addToCart(stan, nama, harga, idMenu) {
            cart.push({ stan, nama, harga, idMenu });
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cont = document.getElementById('cartItems');
            const totalEl = document.getElementById('totalHarga');
            cont.innerHTML = "";
            total = 0;

            cart.forEach((item, index) => {
                total += item.harga;
                cont.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl">
                        <div class="text-[10px] font-bold">
                            <span class="text-indigo-500 uppercase text-[8px]">${item.stan}</span><br>${item.nama}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-black text-slate-600">Rp ${item.harga.toLocaleString()}</span>
                            <button onclick="removeItem(${index})" class="text-red-400 font-bold px-2">Ã—</button>
                        </div>
                    </div>`;
            });

            totalEl.innerText = "Rp " + total.toLocaleString();
            if(cart.length === 0) cont.innerHTML = `<p class="text-center text-slate-300 text-xs italic py-10">Keranjang masih kosong</p>`;
        }

        function removeItem(idx) { cart.splice(idx, 1); updateCartDisplay(); }
        function resetCart() { cart = []; updateCartDisplay(); }

        function bukaScanner() {
            if(cart.length === 0) return alert("Keranjang kosong!");
            document.getElementById('scannerArea').classList.remove('hidden');
            document.getElementById('btnCheckout').classList.add('hidden');
            
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, (idSiswa) => {
                scanner.stop();
                prosesBayar(idSiswa.trim());
            });
        }

        function prosesBayar(idSiswa) {
            db.ref('kantin_users/' + idSiswa).once('value', userSnap => {
                const user = userSnap.val();
                if(!user) return alert("Kartu tidak terdaftar!");
                if(user.saldo < total) return alert("Saldo tidak cukup! Sisa: Rp " + user.saldo.toLocaleString());

                // 1. Potong Saldo Siswa Sekali
                const saldoBaru = user.saldo - total;
                db.ref('kantin_users/' + idSiswa + '/saldo').set(saldoBaru);

                // 2. Pecah Laporan per Stan & Potong Stok
                const waktu = new Date().toLocaleString('id-ID');
                
                // Kelompokkan item per stan untuk laporan
                let perStan = {};
                cart.forEach(item => {
                    if(!perStan[item.stan]) perStan[item.stan] = { total: 0, items: [] };
                    perStan[item.stan].total += item.harga;
                    perStan[item.stan].items.push(item.nama);

                    // Potong Stok di Database
                    db.ref(`kantin_menus/${item.stan}/${item.idMenu}/stok`).transaction(currentStok => {
                        return (currentStok || 0) - 1;
                    });
                });

                // Simpan laporan per stan
                Object.keys(perStan).forEach(namaStan => {
                    db.ref('kantin_laporan').push({
                        idSiswa: idSiswa,
                        namaSiswa: user.nama,
                        stan: namaStan,
                        item: perStan[namaStan].items.join(", "),
                        total: perStan[namaStan].total,
                        waktu: waktu
                    });
                });

                alert("âœ… Pembayaran Berhasil! Sisa Saldo: Rp " + saldoBaru.toLocaleString());
                location.reload();
            });
        }
    </script>
</body>
</html>
