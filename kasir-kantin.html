<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRO KASIR - E-Kantin</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 font-sans min-h-screen">
    <div class="max-w-5xl mx-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <div class="bg-indigo-900 p-6 rounded-[2rem] text-white shadow-xl flex-1 mr-4 border-b-4 border-yellow-400">
                <h1 class="text-xl font-black italic uppercase text-yellow-400">PRO KASIR ðŸš€</h1>
                <p class="text-[9px] font-bold opacity-60 uppercase">Notifikasi WA Otomatis Aktif</p>
            </div>
            <button onclick="window.location.href='index.html'" class="bg-white p-6 rounded-[2rem] shadow font-black text-indigo-900 text-xs">PORTAL</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2" id="menuContainer"></div>
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl sticky top-4 border-t-8 border-indigo-600">
                    <h2 class="text-center font-black text-slate-400 text-[10px] mb-4 uppercase">Keranjang</h2>
                    <div id="cartItems" class="space-y-2 mb-4 max-h-[300px] overflow-y-auto italic"></div>
                    
                    <div class="border-t-2 border-dashed py-4 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-400 uppercase">Total</span>
                            <span id="totalHarga" class="text-2xl font-black text-indigo-600">Rp 0</span>
                        </div>
                    </div>

                    <div id="scannerArea" class="hidden mb-4">
                        <div id="reader" class="rounded-xl overflow-hidden border-4 border-indigo-50"></div>
                    </div>

                    <button id="btnCheckout" onclick="bukaScanner()" class="w-full bg-emerald-500 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs">BAYAR SEKARANG âœ…</button>
                    <button onclick="resetCart()" class="w-full mt-3 text-slate-300 font-bold text-[9px] uppercase">Kosongkan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cart = []; let total = 0;
        // TOKEN FONNTE TERBARU DISISIPKAN DISINI
        const FONNTE_TOKEN = "eRiRwGfU96GqAyaMXM7Q"; 

        db.ref('kantin_menus').on('value', snap => {
            const container = document.getElementById('menuContainer'); container.innerHTML = "";
            snap.forEach(stanSnap => {
                let html = `<div class="bg-white p-4 rounded-[2rem] shadow-sm mb-4"><h3 class="text-[10px] font-black text-indigo-500 uppercase mb-3 border-b pb-1">${stanSnap.key}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                stanSnap.forEach(mSnap => {
                    const m = mSnap.val();
                    const sisa = (m.stok_awal - (m.terjual || 0));
                    const habis = sisa <= 0;
                    html += `<button onclick="${habis ? "alert('Stok Habis!')" : `addToCart('${stanSnap.key}','${m.nama}',${m.harga},'${mSnap.key}')`}" class="${habis?'opacity-30 cursor-not-allowed':'hover:bg-indigo-50'} p-3 bg-slate-50 rounded-xl flex justify-between text-left italic font-bold"><div><p class="text-[11px] uppercase">${m.nama}</p><p class="text-[10px] text-emerald-600">Rp ${m.harga.toLocaleString()}</p></div><span class="text-[8px] text-slate-400 uppercase">Sisa: ${sisa < 0 ? 0 : sisa}</span></button>`;
                });
                container.innerHTML += html + `</div></div>`;
            });
        });

        function addToCart(stan, nama, harga, idMenu) { cart.push({ stan, nama, harga, idMenu }); updateCartDisplay(); }
        function updateCartDisplay() {
            const cont = document.getElementById('cartItems'); cont.innerHTML = ""; total = 0;
            cart.forEach((item, index) => { total += item.harga; cont.innerHTML += `<div class="flex justify-between bg-slate-50 p-2 rounded-lg text-[10px]"><span>${item.nama}</span><button onclick="removeItem(${index})" class="text-red-500 font-bold">Ã—</button></div>`; });
            document.getElementById('totalHarga').innerText = "Rp " + total.toLocaleString();
        }
        function removeItem(idx) { cart.splice(idx,1); updateCartDisplay(); }
        function resetCart() { cart = []; updateCartDisplay(); }

        let scanner;
        function bukaScanner() {
            if(cart.length === 0) return alert("Keranjang kosong!");
            document.getElementById('scannerArea').classList.remove('hidden');
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (id) => { 
                scanner.stop().then(() => {
                    document.getElementById('scannerArea').classList.add('hidden');
                    prosesBayar(id.trim()); 
                });
            }).catch(err => alert("Kamera Error: " + err));
        }

        function prosesBayar(idSiswa) {
            db.ref('kantin_users/' + idSiswa).once('value', userSnap => {
                const user = userSnap.val();
                if(!user) return alert("ID Siswa Tidak Ditemukan!");
                if(user.saldo < total) return alert("Saldo " + user.nama + " tidak cukup!");

                const saldoBaru = user.saldo - total;
                const waktu = new Date().toLocaleString('id-ID');
                let detailItems = "";
                let itemLog = [];

                cart.forEach(item => {
                    detailItems += `- ${item.nama} (Rp ${item.harga.toLocaleString()})\n`;
                    itemLog.push(item.nama);
                    const menuRef = db.ref(`kantin_menus/${item.stan}/${item.idMenu}`);
                    menuRef.transaction(c => { 
                        if(c){ 
                            c.terjual=(c.terjual||0)+1; 
                            c.stok_akhir=c.stok_awal-c.terjual; 
                            c.stok=c.stok_akhir; 
                        } 
                        return c; 
                    });
                });

                db.ref('kantin_users/' + idSiswa + '/saldo').set(saldoBaru);

                // SIMPAN DENGAN FIELD KELAS (Dukungan penuh untuk Admin)
                db.ref('kantin_laporan').push({ 
                    idSiswa, 
                    namaSiswa: user.nama, 
                    kelas: user.kelas || '-', 
                    total, 
                    item: itemLog.join(", "), 
                    stan: "Multi-Stan", 
                    waktu 
                });

                if (user.wa) {
                    const pesan = `*STRUK DIGITAL E-KANTIN*\n\nAnanda: *${user.nama}*\n\n*Detail Belanja:*\n${detailItems}\n*Total: Rp ${total.toLocaleString()}*\n*Sisa Saldo: Rp ${saldoBaru.toLocaleString()}*\n\n_Terima kasih telah berbelanja_`;
                    fetch('https://api.fonnte.com/send', { 
                        method: 'POST', 
                        headers: { 'Authorization': FONNTE_TOKEN }, 
                        body: new URLSearchParams({ 'target': user.wa, 'message': pesan }) 
                    });
                }
                alert("âœ… BERHASIL!\nSiswa: " + user.nama + "\nSisa Saldo: Rp " + saldoBaru.toLocaleString());
                resetCart();
            });
        }
    </script>
</body>
</html>
