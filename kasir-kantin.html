<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Pintar E-Kantin</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-24">

    <div class="bg-indigo-700 p-6 text-white shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="font-black italic text-lg">KASIR SCANNER ðŸ›’</h1>
            <select id="pilihStan" onchange="loadMenuByStan()" class="bg-indigo-800 text-[10px] p-2 rounded-xl border border-indigo-400 font-bold outline-none">
                <option value="">PILIH STAN...</option>
                <option value="STAN MAKANAN">STAN MAKANAN</option>
                <option value="STAN MINUMAN">STAN MINUMAN</option>
            </select>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-4">
        <div class="bg-white p-4 rounded-[2rem] shadow-sm border-2 border-white">
            <div id="reader" class="rounded-2xl overflow-hidden bg-black"></div>
            <div id="scanResult" class="mt-4 p-4 bg-green-50 rounded-2xl border border-green-100 hidden">
                <p class="text-[9px] font-bold text-green-600 uppercase">Siswa Terdeteksi:</p>
                <h2 id="resNama" class="text-lg font-black text-indigo-900">-</h2>
                <p id="resSaldo" class="text-sm font-bold text-slate-500">Saldo: Rp 0</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-sm">
            <h3 class="font-black text-slate-400 text-[10px] uppercase mb-4 tracking-widest">Daftar Menu Stan</h3>
            <div id="containerMenu" class="grid grid-cols-2 gap-3">
                <p class="text-[10px] text-slate-300 italic col-span-2 text-center">Silakan pilih stan terlebih dahulu...</p>
            </div>
        </div>

        <div class="bg-indigo-900 p-6 rounded-[2.5rem] shadow-xl text-center border-t-4 border-yellow-400">
            <div class="flex justify-between items-center mb-2 px-2">
                <span class="text-indigo-300 text-[10px] font-bold uppercase">Total Tagihan:</span>
                <button onclick="resetOrder()" class="text-[9px] bg-red-500 text-white px-2 py-1 rounded-md font-bold">RESET</button>
            </div>
            <h1 id="displayTotal" class="text-3xl font-black text-yellow-400">Rp 0</h1>
            
            <button id="btnBayar" onclick="prosesBayar()" disabled class="w-full mt-6 bg-slate-500 text-white font-black p-4 rounded-2xl shadow-lg uppercase tracking-tighter disabled:opacity-50">
                KONFIRMASI BAYAR ðŸ’¸
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentSiswaID = null;
        let currentSiswaNama = "";
        let currentSiswaSaldo = 0;
        let totalBelanja = 0;

        // 1. FUNGSI AMBIL MENU DARI DATABASE BERDASARKAN STAN
        function loadMenuByStan() {
            const stan = document.getElementById('pilihStan').value;
            const container = document.getElementById('containerMenu');
            container.innerHTML = "Memuat menu...";

            if(!stan) return;

            // Kita ambil data dari folder 'kantin_menus'
            db.ref('kantin_menus/' + stan).on('value', (snapshot) => {
                container.innerHTML = "";
                if(snapshot.exists()){
                    snapshot.forEach(child => {
                        const item = child.val();
                        container.innerHTML += `
                            <button onclick="addToCart(${item.harga})" class="p-4 bg-slate-50 rounded-2xl border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 transition-all text-left">
                                <p class="text-[10px] font-black text-indigo-600 uppercase truncate">${item.nama}</p>
                                <p class="text-sm font-black text-slate-700">Rp ${item.harga.toLocaleString()}</p>
                            </button>
                        `;
                    });
                } else {
                    container.innerHTML = "<p class='text-[10px] col-span-2 text-center'>Menu belum diinput di Admin.</p>";
                }
            });
        }

        function addToCart(harga) {
            totalBelanja += harga;
            updateUI();
        }

        function resetOrder() {
            totalBelanja = 0;
            updateUI();
        }

        function updateUI() {
            document.getElementById('displayTotal').innerText = "Rp " + totalBelanja.toLocaleString();
            const btn = document.getElementById('btnBayar');
            if(currentSiswaID && totalBelanja > 0) {
                btn.disabled = false;
                btn.classList.replace('bg-slate-500', 'bg-green-500');
            } else {
                btn.disabled = true;
            }
        }

        // 2. FUNGSI SCANNER
        function onScanSuccess(decodedText) {
            currentSiswaID = decodedText;
            db.ref('kantin_users/' + currentSiswaID).once('value').then(snap => {
                if(snap.exists()){
                    const d = snap.val();
                    currentSiswaNama = d.nama;
                    currentSiswaSaldo = d.saldo;
                    document.getElementById('scanResult').classList.remove('hidden');
                    document.getElementById('resNama').innerText = currentSiswaNama;
                    document.getElementById('resSaldo').innerText = "Saldo: Rp " + currentSiswaSaldo.toLocaleString();
                    updateUI();
                } else {
                    alert("KARTU TIDAK TERDAFTAR!");
                }
            });
        }

        let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 200 });
        html5QrcodeScanner.render(onScanSuccess);

        // 3. PROSES BAYAR
        function prosesBayar() {
            if(currentSiswaSaldo < totalBelanja) return alert("SALDO TIDAK CUKUP!");
            
            const saldoBaru = currentSiswaSaldo - totalBelanja;
            const stan = document.getElementById('pilihStan').value;

            db.ref('kantin_users/' + currentSiswaID).update({ saldo: saldoBaru });
            db.ref('kantin_transactions/' + Date.now()).set({
                siswa_id: currentSiswaID,
                nama_siswa: currentSiswaNama,
                nominal: totalBelanja,
                stan: stan,
                waktu: new Date().toLocaleString('id-ID')
            }).then(() => {
                alert("PEMBAYARAN BERHASIL!");
                location.reload();
            });
        }
    </script>
</body>
</html>
