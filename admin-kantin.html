<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir E-Kantin - SD Indonesia Hebat</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-100 font-sans">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-indigo-900 text-white p-6 rounded-3xl shadow-lg mb-6">
            <h1 class="text-lg font-black italic">POS KASIR E-KANTIN</h1>
            <p class="text-[10px] text-indigo-300">Tap kartu atau Scan QR untuk transaksi</p>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm mb-4 border border-slate-200">
            <input type="text" id="idKartu" placeholder="Scan Kartu..." 
                   class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none ring-2 ring-indigo-500 mb-4" autofocus>
            
            <div id="infoSiswa" class="hidden text-center p-4 bg-indigo-50 rounded-2xl mb-4">
                <p id="dispNama" class="font-black text-indigo-900 uppercase text-sm"></p>
                <p id="dispSaldo" class="font-bold text-emerald-600 text-xs"></p>
            </div>

            <input type="number" id="inputNominal" placeholder="Masukkan Nominal Rp..." 
                   class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-b-4 border-orange-500 mb-4 text-xl">
            
            <button onclick="prosesTransaksi()" 
                    class="w-full bg-orange-500 text-white font-black py-4 rounded-2xl shadow-lg uppercase tracking-widest hover:bg-orange-600">
                BAYAR SEKARANG
            </button>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE (PASTIKAN SAMA DENGAN ADMIN)
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. CEK DATA SISWA SAAT SCAN (Auto-cek)
        document.getElementById('idKartu').addEventListener('change', function(e) {
            const id = e.target.value;
            db.ref('kantin_users/' + id).once('value', snap => {
                const d = snap.val();
                if(d) {
                    document.getElementById('infoSiswa').classList.remove('hidden');
                    document.getElementById('dispNama').innerText = d.nama;
                    document.getElementById('dispSaldo').innerText = "Saldo: Rp " + d.saldo.toLocaleString();
                } else {
                    alert("Siswa tidak ditemukan!");
                    e.target.value = "";
                }
            });
        });

        // 2. PROSES TRANSAKSI & KIRIM WA
        function prosesTransaksi() {
            const id = document.getElementById('idKartu').value;
            const nominal = parseInt(document.getElementById('inputNominal').value);

            if(!id || !nominal) { alert("Scan kartu & isi nominal!"); return; }

            db.ref('kantin_users/' + id).once('value', snap => {
                const user = snap.val();
                
                if (user.saldo >= nominal) {
                    const saldoBaru = user.saldo - nominal;
                    const waktu = new Date().toLocaleString('id-ID');

                    // A. Update Saldo
                    db.ref('kantin_users/' + id).update({ saldo: saldoBaru });

                    // B. Simpan Log Laporan
                    const log = {
                        idSiswa: id,
                        namaSiswa: user.nama,
                        total: nominal,
                        stan: "Kantin Utama",
                        item: "Pembelian Kantin",
                        waktu: waktu
                    };
                    
                    db.ref('kantin_laporan').push(log).then(() => {
                        alert("✅ TRANSAKSI BERHASIL!");

                        // C. KIRIM NOTIFIKASI WA (Hanya jika ada nomor WA)
                        if (user.wa) {
                            kirimPesanWA(user.wa, user.nama, nominal, saldoBaru);
                        }

                        location.reload(); 
                    });

                } else {
                    alert("❌ SALDO TIDAK CUKUP!");
                }
            });
        }

        // 3. FUNGSI KIRIM WA (MENGGUNAKAN MODE REDIRECT CEPAT)
        function kirimPesanWA(nomor, nama, nominal, sisa) {
            const pesan = `*INFO E-KANTIN*\n\nAnanda *${nama}* baru saja bertransaksi.\nNominal: *Rp ${nominal.toLocaleString()}*\nSisa Saldo: *Rp ${sisa.toLocaleString()}*\n\n_SD Indonesia Hebat_`;
            
            // Format nomor agar diawali 62
            let formatNomor = nomor;
            if(formatNomor.startsWith('0')) formatNomor = '62' + formatNomor.slice(1);
            
            // Mode Redirect (Buka Tab WA Sejenak)
            const url = `https://api.whatsapp.com/send?phone=${formatNomor}&text=${encodeURIComponent(pesan)}`;
            
            // Membuka WA di window kecil/tab baru agar tidak mengganggu kasir
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
