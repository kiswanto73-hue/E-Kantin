<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Laporan Bulanan</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div class="bg-indigo-900 text-white p-6 rounded-b-[3rem] shadow-xl mb-6">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black uppercase italic tracking-tighter">Admin Control üõ°Ô∏è</h1>
                <p class="text-[10px] font-bold text-indigo-300 uppercase tracking-[0.2em]">Laporan & Monitoring Pusat</p>
            </div>
            <div class="flex gap-2">
                <a href="manajemen-menu.html" class="bg-emerald-500 px-4 py-2 rounded-xl text-[10px] font-bold uppercase">Atur Menu</a>
                <a href="index.html" class="bg-red-500 px-4 py-2 rounded-xl text-[10px] font-bold uppercase">Keluar</a>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-4">
        
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm mb-8 border border-indigo-50">
            <h3 class="text-xs font-black text-indigo-900 mb-4 uppercase">üìÖ Filter Laporan Bulanan</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="space-y-1">
                    <label class="text-[8px] font-bold text-slate-400 uppercase">Pilih Bulan</label>
                    <select id="filterBulan" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none border border-slate-100">
                        <option value="01">Januari</option> <option value="02">Februari</option>
                        <option value="03">Maret</option> <option value="04">April</option>
                        <option value="05">Mei</option> <option value="06">Juni</option>
                        <option value="07">Juli</option> <option value="08">Agustus</option>
                        <option value="09">September</option> <option value="10">Oktober</option>
                        <option value="11">November</option> <option value="12">Desember</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[8px] font-bold text-slate-400 uppercase">Pilih Tahun</label>
                    <input type="number" id="filterTahun" value="2024" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none border border-slate-100">
                </div>
                <div class="col-span-2 flex items-end">
                    <button onclick="tarikLaporan()" class="w-full bg-indigo-600 text-white font-black py-3 rounded-xl text-[10px] uppercase hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                        Tampilkan Laporan üìä
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border-l-8 border-emerald-500">
                <p class="text-[8px] font-black text-slate-400 uppercase">Total Omzet</p>
                <h2 id="totalOmzet" class="text-xl font-black text-indigo-900 mt-1">Rp 0</h2>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border-l-8 border-indigo-500">
                <p class="text-[8px] font-black text-slate-400 uppercase">Total Transaksi</p>
                <h2 id="totalTrx" class="text-xl font-black text-indigo-900 mt-1">0</h2>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border-l-8 border-yellow-500 col-span-2 md:col-span-1">
                <p class="text-[8px] font-black text-slate-400 uppercase">Siswa Teraktif</p>
                <h2 id="siswaTop" class="text-sm font-black text-indigo-900 mt-1 uppercase">-</h2>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm overflow-hidden border border-slate-100">
            <div class="bg-slate-50 px-8 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Rincian Transaksi Bulanan</h3>
                <button onclick="window.print()" class="text-[8px] font-black text-indigo-600 uppercase">Cetak / PDF üñ®Ô∏è</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/50">
                            <th class="p-5 text-[9px] font-black text-slate-400 uppercase">Waktu</th>
                            <th class="p-5 text-[9px] font-black text-slate-400 uppercase">Siswa</th>
                            <th class="p-5 text-[9px] font-black text-slate-400 uppercase">Menu</th>
                            <th class="p-5 text-[9px] font-black text-slate-400 uppercase text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="tabelLaporan" class="text-[10px] font-bold text-slate-600 divide-y divide-slate-50">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // CEK LOGIN
        if (sessionStorage.getItem("ownerLoggedIn") !== "true") { window.location.replace("index.html"); }

        // FUNGSI TARIK LAPORAN BULANAN
        function tarikLaporan() {
            const bulan = document.getElementById('filterBulan').value;
            const tahun = document.getElementById('filterTahun').value;
            const targetBulan = tahun + "-" + bulan; // Format: 2024-05

            const table = document.getElementById('tabelLaporan');
            table.innerHTML = "<tr><td colspan='4' class='p-10 text-center italic'>Menarik data...</td></tr>";

            db.ref('kantin_transaksi').once('value', snapshot => {
                let html = "";
                let totalDuit = 0;
                let jumlahTrx = 0;
                let dataSiswa = {};

                snapshot.forEach(child => {
                    const trx = child.val();
                    // Cek apakah tanggal transaksi diawali dengan YYYY-MM
                    if (trx.waktu && trx.waktu.startsWith(targetBulan)) {
                        totalDuit += trx.total;
                        jumlahTrx++;
                        
                        // Hitung siswa teraktif
                        dataSiswa[trx.nama_siswa] = (dataSiswa[trx.nama_siswa] || 0) + 1;

                        html += `
                            <tr class="hover:bg-indigo-50/30 transition-all">
                                <td class="p-5 font-mono text-[9px]">${trx.waktu}</td>
                                <td class="p-5 uppercase">${trx.nama_siswa}</td>
                                <td class="p-5 italic text-slate-400">${trx.detail_pesanan}</td>
                                <td class="p-5 text-right font-black text-indigo-600">Rp ${trx.total.toLocaleString()}</td>
                            </tr>
                        `;
                    }
                });

                if (jumlahTrx > 0) {
                    table.innerHTML = html;
                    document.getElementById('totalOmzet').innerText = "Rp " + totalDuit.toLocaleString();
                    document.getElementById('totalTrx').innerText = jumlahTrx;
                    
                    // Cari nama siswa paling banyak transaksi
                    const topSiswa = Object.keys(dataSiswa).reduce((a, b) => dataSiswa[a] > dataSiswa[b] ? a : b);
                    document.getElementById('siswaTop').innerText = topSiswa;
                } else {
                    table.innerHTML = "<tr><td colspan='4' class='p-10 text-center text-red-400 font-bold'>Tidak ada data di bulan ini.</td></tr>";
                    document.getElementById('totalOmzet').innerText = "Rp 0";
                    document.getElementById('totalTrx').innerText = "0";
                    document.getElementById('siswaTop').innerText = "-";
                }
            });
        }

        // Jalankan saat pertama kali buka
        window.onload = () => {
            const d = new Date();
            document.getElementById('filterBulan').value = ("0" + (d.getMonth() + 1)).slice(-2);
            document.getElementById('filterTahun').value = d.getFullYear();
            tarikLaporan();
        };
    </script>
</body>
</html>
