<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SD Indonesia Hebat</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen font-sans">

    <div class="bg-indigo-950 text-white p-8 rounded-b-[4rem] shadow-2xl border-b-8 border-yellow-400">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-3xl font-black uppercase italic tracking-tighter leading-none">Management Center üõ°Ô∏è</h1>
                <p class="text-xs font-bold text-yellow-400 uppercase tracking-[0.3em] mt-2">SD Indonesia Hebat - E-Kantin System</p>
            </div>
            <div class="flex gap-3">
                <a href="manajemen-menu.html" class="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-2xl text-[10px] font-black uppercase shadow-lg transition-all">üç± Atur Stok</a>
                <a href="index.html" class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-2xl text-[10px] font-black uppercase shadow-lg transition-all">üö™ Keluar</a>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8 -mt-10">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border-b-4 border-indigo-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Total Nasabah</p>
                <h2 id="jmlSiswa" class="text-4xl font-black text-indigo-900 mt-2">0</h2>
                <p class="text-[9px] font-bold text-indigo-400 mt-1 uppercase italic leading-none">Siswa Terdaftar</p>
            </div>
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border-b-4 border-emerald-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Total Dana Siswa</p>
                <h2 id="totalTabungan" class="text-4xl font-black text-emerald-600 mt-2">Rp 0</h2>
                <p class="text-[9px] font-bold text-emerald-400 mt-1 uppercase italic leading-none">Saldo Mengendap</p>
            </div>
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border-b-4 border-yellow-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Omzet Hari Ini</p>
                <h2 id="omzetHariIni" class="text-4xl font-black text-indigo-900 mt-2">Rp 0</h2>
                <p class="text-[9px] font-bold text-yellow-600 mt-1 uppercase italic leading-none">Transaksi Berhasil</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1">
                <div class="bg-white p-8 rounded-[3.5rem] shadow-xl sticky top-8 border border-indigo-50">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-indigo-100 p-2 rounded-2xl">üë§</span>
                        <h3 class="text-sm font-black text-indigo-900 uppercase italic">Input Data Siswa</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4 mb-2 block">ID Kartu (Scan/Ketik)</label>
                            <input type="text" id="siswaID" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-sm outline-none focus:ring-4 ring-indigo-500 transition-all">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4 mb-2 block">Nama Lengkap Siswa</label>
                            <input type="text" id="siswaNama" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-sm outline-none focus:ring-4 ring-indigo-500 transition-all uppercase">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4 mb-2 block">Kelas</label>
                            <input type="text" id="siswaKelas" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-sm outline-none focus:ring-4 ring-indigo-500 transition-all uppercase">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4 mb-2 block">Setoran Saldo (Rp)</label>
                            <input type="number" id="siswaSaldo" class="w-full p-4 bg-emerald-50 text-emerald-700 rounded-2xl font-black text-sm outline-none focus:ring-4 ring-emerald-500 transition-all">
                        </div>
                        
                        <button onclick="simpanSiswa()" class="w-full bg-indigo-600 text-white font-black py-5 rounded-[2rem] shadow-lg hover:bg-indigo-700 active:scale-95 transition-all uppercase text-[10px] tracking-widest mt-4">
                            Simpan & Update Data üöÄ
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-[3.5rem] shadow-xl overflow-hidden border border-slate-50">
                    <div class="p-8 bg-slate-50/50 flex justify-between items-center border-b border-slate-100">
                        <h3 class="text-xs font-black text-slate-500 uppercase italic">Nasabah E-Kantin Terdaftar</h3>
                        <span class="bg-indigo-100 text-indigo-600 text-[10px] font-black px-4 py-1 rounded-full uppercase">Real-Time Data</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase">
                                <tr>
                                    <th class="p-6">ID Kartu</th>
                                    <th class="p-6">Nama Siswa</th>
                                    <th class="p-6">Kelas</th>
                                    <th class="p-6 text-right">Saldo</th>
                                    <th class="p-6 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="listSiswa" class="text-xs font-bold text-slate-600 divide-y divide-slate-50">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-indigo-900 rounded-[3.5rem] p-8 shadow-2xl text-white border-b-8 border-emerald-500">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-sm font-black uppercase italic tracking-widest">Laporan Bulanan üìä</h3>
                        <div class="flex gap-2">
                            <select id="fBulan" class="bg-white/10 p-2 rounded-xl text-[10px] font-bold border-none outline-none">
                                <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                                <option value="04" selected>April</option><option value="05">Mei</option><option value="06">Juni</option>
                            </select>
                            <button onclick="tarikLaporan()" class="bg-yellow-400 text-indigo-900 px-4 py-2 rounded-xl text-[10px] font-black uppercase">Tampilkan</button>
                        </div>
                    </div>
                    
                    <div id="areaLaporan" class="hidden">
                        <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                            <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
                                <p class="text-[8px] uppercase opacity-60">Omzet Terpilih</p>
                                <p id="totalOmzet" class="text-xl font-black text-emerald-400 mt-1">Rp 0</p>
                            </div>
                            <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
                                <p class="text-[8px] uppercase opacity-60">Total Transaksi</p>
                                <p id="totalTrx" class="text-xl font-black text-yellow-400 mt-1">0</p>
                            </div>
                        </div>
                        <div class="max-h-60 overflow-y-auto rounded-2xl bg-white/5 p-2">
                            <table class="w-full text-[9px] text-left uppercase font-bold">
                                <tbody id="tabelLaporan" class="divide-y divide-white/10"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE (TETAP PAKAI PUNYA BAPAK)
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // PROTEKSI LOGIN
        if (sessionStorage.getItem("ownerLoggedIn") !== "true") { window.location.replace("index.html"); }

        // --- MONITORING SISWA REAL-TIME ---
        db.ref('kantin_users').on('value', snap => {
            const table = document.getElementById('listSiswa');
            table.innerHTML = "";
            let totalS = 0, jml = 0;
            snap.forEach(child => {
                const s = child.val();
                totalS += s.saldo; jml++;
                table.innerHTML += `
                    <tr class="hover:bg-indigo-50/50 transition-all">
                        <td class="p-6 font-mono text-indigo-900">${child.key}</td>
                        <td class="p-6 text-slate-900 uppercase">${s.nama}</td>
                        <td class="p-6">${s.kelas || '-'}</td>
                        <td class="p-6 text-right font-black text-emerald-600 italic text-sm">Rp ${s.saldo.toLocaleString()}</td>
                        <td class="p-6 text-center flex gap-2 justify-center">
                            <button onclick="editSiswa('${child.key}', '${s.nama}', '${s.kelas}', ${s.saldo})" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">‚úèÔ∏è</button>
                            <button onclick="hapusSiswa('${child.key}')" class="p-2 bg-red-50 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition-all">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('totalTabungan').innerText = "Rp " + totalS.toLocaleString();
            document.getElementById('jmlSiswa').innerText = jml;
        });

        // --- OMZET HARI INI ---
        const hariIni = new Date().toISOString().split('T')[0];
        db.ref('kantin_transaksi').on('value', snap => {
            let total = 0;
            snap.forEach(child => {
                if(child.val().waktu && child.val().waktu.startsWith(hariIni)) {
                    total += child.val().total;
                }
            });
            document.getElementById('omzetHariIni').innerText = "Rp " + total.toLocaleString();
        });

        function simpanSiswa() {
            const id = document.getElementById('siswaID').value.trim();
            const nm = document.getElementById('siswaNama').value.trim().toUpperCase();
            const kl = document.getElementById('siswaKelas').value.trim().toUpperCase();
            const sl = parseInt(document.getElementById('siswaSaldo').value) || 0;
            if(id && nm) {
                db.ref('kantin_users/' + id).set({ nama: nm, kelas: kl, saldo: sl })
                .then(() => { alert("Berhasil Diupdate!"); resetForm(); });
            } else { alert("Minimal ID dan Nama diisi!"); }
        }

        function editSiswa(id, nm, kl, sl) {
            document.getElementById('siswaID').value = id;
            document.getElementById('siswaNama').value = nm;
            document.getElementById('siswaKelas').value = kl;
            document.getElementById('siswaSaldo').value = sl;
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function hapusSiswa(id) { if(confirm("Hapus Siswa?")) db.ref('kantin_users/' + id).remove(); }
        function resetForm() { document.getElementById('siswaID').value = ""; document.getElementById('siswaNama').value = ""; document.getElementById('siswaKelas').value = ""; document.getElementById('siswaSaldo').value = ""; }

        // --- LAPORAN BULANAN (FITUR TAMBAHAN) ---
        function tarikLaporan() {
            const filter = "2024-" + document.getElementById('fBulan').value;
            const tBody = document.getElementById('tabelLaporan');
            document.getElementById('areaLaporan').classList.remove('hidden');
            tBody.innerHTML = "";
            db.ref('kantin_transaksi').once('value', snap => {
                let total = 0, count = 0;
                snap.forEach(child => {
                    const trx = child.val();
                    if(trx.waktu && trx.waktu.startsWith(filter)) {
                        total += trx.total; count++;
                        tBody.innerHTML += `
                            <tr>
                                <td class="p-3 text-white/40">${trx.waktu.split(' ')[0]}</td>
                                <td class="p-3 text-white/90">${trx.nama_siswa}</td>
                                <td class="p-3 text-right text-emerald-400 font-black">Rp ${trx.total.toLocaleString()}</td>
                            </tr>
                        `;
                    }
                });
                document.getElementById('totalOmzet').innerText = "Rp " + total.toLocaleString();
                document.getElementById('totalTrx').innerText = count;
            });
        }
    </script>
</body>
</html>
