<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusat Kendali & Admin E-Kantin</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-100 p-2 md:p-6 font-sans">
    <script>
        // CONFIG FIREBASE BAPAK
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let myChart = null;

        auth.onAuthStateChanged(user => { if(!user) window.location.href="login.html"; });

        // FUNGSI LOAD DATA (DI SINI SAYA INTEGRASIKAN LAPORAN BULANAN)
        function loadData() {
            const filterTgl = document.getElementById('filterTanggal').value; // Contoh: 2024-05-30
            const filterKls = document.getElementById('filterKelas').value;
            
            // 1. DAFTAR SISWA (Fungsi Asli Bapak)
            db.ref('kantin_users').on('value', snap => {
                const cont = document.getElementById('siswaList'); cont.innerHTML = "";
                snap.forEach(s => {
                    const d = s.val();
                    if(filterKls === "SEMUA" || d.kelas === filterKls) {
                        cont.innerHTML += `
                            <div class="p-3 bg-slate-50 rounded-2xl flex justify-between items-center border border-slate-100">
                                <div>
                                    <span class="bg-indigo-600 text-white text-[7px] font-black px-2 py-0.5 rounded-md uppercase">${d.kelas || 'N/A'}</span>
                                    <p class="text-[10px] font-black text-slate-700 uppercase mt-1 leading-none">${d.nama}</p>
                                    <p class="text-[9px] font-bold text-emerald-600 mt-1">Rp ${d.saldo.toLocaleString()}</p>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="isiForm('${d.id}','${d.nama}','${d.kelas}',${d.saldo})" class="p-2 bg-indigo-600 text-white rounded-lg text-[8px] font-black">EDIT</button>
                                    <button onclick="hapusSiswa('${d.id}')" class="p-2 bg-red-100 text-red-500 rounded-lg text-[8px] font-black">Ã—</button>
                                </div>
                            </div>`;
                    }
                });
            });

            // 2. LOG & LAPORAN (LOGIKA LAPORAN BULANAN OTOMATIS)
            db.ref('kantin_laporan').on('value', snap => {
                const body = document.getElementById('logTableBody'); body.innerHTML = "";
                let totalSmua = 0; 
                let stanGrup = {};
                
                // Ambil Bulan-Tahun dari filter tanggal (jika ada)
                const filterBulan = filterTgl ? filterTgl.substring(0, 7) : ""; // Hasil: "2024-05"

                snap.forEach(l => {
                    const d = l.val();
                    // Konversi waktu Firebase ke format YYYY-MM-DD
                    const tglData = d.waktu.split(',')[0].split('/').reverse().join('-'); 
                    const bulanData = tglData.substring(0, 7);

                    // LOGIKA FILTER:
                    // Jika tanggal dipilih -> Tampilkan harian
                    // Jika tanggal kosong -> Tampilkan semua transaksi bulan ini
                    let lolosFilter = false;
                    if (!filterTgl) {
                        // Jika filter tanggal kosong, tampilkan transaksi bulan berjalan
                        const bulanSekarang = new Date().toISOString().substring(0, 7);
                        if (bulanData === bulanSekarang) lolosFilter = true;
                    } else if (tglData === filterTgl) {
                        lolosFilter = true;
                    }

                    if(lolosFilter) {
                        totalSmua += d.total;
                        stanGrup[d.stan] = (stanGrup[d.stan] || 0) + d.total;
                        body.innerHTML = `<tr><td class="p-3 text-slate-400 italic font-normal">${d.waktu}</td><td>${d.namaSiswa}</td><td><span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full uppercase">${d.stan}</span></td><td>${d.item}</td><td class="text-right p-3 text-green-600 font-black">Rp ${d.total.toLocaleString()}</td></tr>` + body.innerHTML;
                    }
                });

                document.getElementById('totalOmzet').innerText = "Rp " + totalSmua.toLocaleString();
                const breakEl = document.getElementById('breakdownStan'); breakEl.innerHTML = "";
                Object.keys(stanGrup).forEach(s => { 
                    breakEl.innerHTML += `<div class="flex justify-between border-b border-slate-50"><span>${s}</span><span>Rp ${stanGrup[s].toLocaleString()}</span></div>`; 
                });
                updateChart(stanGrup);
            });
        }

        // SEMUA FUNGSI LAIN (updateSiswa, cetakKolektif, updateChart, dll) 
        // TETAP GUNAKAN MILIK BAPAK TANPA PERUBAHAN
        // ... (copy paste dari kode Bapak di atas) ...
    </script>
</body>
</html>
